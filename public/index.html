<html lang="en">
<head>
    <style>
        body {
            margin:0;
            background:white
        }
    </style>
    <script>
        let ws = [], ctx = null
        let name = "";

        const handleSubmit = (e)=>{
            e.preventDefault();
            const input = document.getElementById("username");
            if(input){
                if(input.value === ""){
                    const error = document.getElementById("error");
                    error.innerText = "Cannot have blank name";
                    setTimeout(()=>{error.innerText = ""}, 1000);
                }
                else if(input.value === "server"){
                    const error = document.getElementById("error");
                    error.innerText = "Cannot use this name";
                    setTimeout(()=>{error.innerText = ""}, 1000);
                }
                else{
                    name = input.value;
                    document.getElementById("form-container").remove();
                    document.getElementById("messages-container").setAttribute("style","justify-content: center; align-items: center; text-align: center;align-self:center;border:1px solid black;background-color:lightgray;width:50%;margin-top:2em;margin-left:auto;margin-right:auto;");
                    ws = new WebSocket( 'ws://127.0.0.1:3000' )

                    ws.onopen = () => {
                        ws.send(`server: ${name} has joined`)
                        ws.onmessage = async msg => {
                            const messages = document.getElementById("messages");
                            if(messages) {
                                const pos = await msg.data.text();
                                const [user, message] = pos.split(':');
                                const toAdd = document.createElement("p");
                                toAdd.innerText = `${user}:${message}`;
                                toAdd.setAttribute("style", "color:lightblue;");
                                toAdd.style.textAlign = "left";
                                toAdd.style.overflow = "auto";
                                messages.appendChild(toAdd);

                            }

                        }
                    }
                }

            }
        }

        const handleNewMessage = (e) => {
            e.preventDefault();
            const input = document.getElementById("message");
            if(input){
                const message = input.value;
                const messages = document.getElementById("messages");
                if(messages) {
                    const toAdd = document.createElement("p");
                    toAdd.innerText = `self: ${message}`;
                    toAdd.setAttribute("style", "color:blue;");
                    toAdd.style.textAlign = "left";
                    toAdd.style.overflow = "auto";
                    messages.appendChild(toAdd);
                    input.value = "";
                }
                ws.send(`${name}: ${message}`)

            }
        }

        window.onload = function() {

            document.getElementById('username-form').addEventListener('submit', handleSubmit);
            document.getElementById('message-form').addEventListener('submit', handleNewMessage);

        }
    </script>
</head>
<body>
    <div id="form-container" style="justify-content: center; align-items: center; text-align: center;align-self:center;">
        <h1  style="margin-top: 2em">Enter name to continue</h1>
        <form id="username-form">
            <label for = "username">Name:</label>
            <input type="text" placeholder="enter name" id = "username"/>
            <button type = "submit" id = "submit">submit</button>
        </form>
        <p id="error" style="color:red"></p>
    </div>
    <div id = "messages-container" style="display:none;">
        <h1 style="margin-top: 1em; margin-bottom:1em">Chat</h1>
        <div id="messages" style="padding-top:1em;padding-bottom:1em;padding-right:.5em;padding-left:.5em;margin-left:auto;margin-right:auto;width:75%;height:75%;border:1px solid black;border-radius:10px;overflow-y:scroll"></div>
        <form id="message-form" style="margin-top: 1em; padding:.5em;margin-left:auto;margin-right:auto;width:75%;border:1px solid black;border-radius:10px">
            <label for = "message">Message:</label>
            <input type="text" placeholder="..." id = "message"/>
        </form>
    </div>

</body>
</html>